<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Introduction  Basically, this CVE is a buffer overflow issue. From the previous description, we can tell that the issue is from a service called TIPC. So at the very beginning we should know what it i">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-43267 with CodeQL">
<meta property="og:url" content="http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/index.html">
<meta property="og:site_name" content="Where Lothar Writes Blogs">
<meta property="og:description" content="Introduction  Basically, this CVE is a buffer overflow issue. From the previous description, we can tell that the issue is from a service called TIPC. So at the very beginning we should know what it i">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://lotharshi.github.io/images/image-20230111150424481.png">
<meta property="article:published_time" content="2023-01-11T07:01:09.000Z">
<meta property="article:modified_time" content="2023-01-24T08:32:25.528Z">
<meta property="article:author" content="Lothar">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://lotharshi.github.io/images/image-20230111150424481.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>CVE-2021-43267 with CodeQL</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/categories/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/LotharShi">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/01/03/CVE-2021-44228-with-CodeQL/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&text=CVE-2021-43267 with CodeQL"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&title=CVE-2021-43267 with CodeQL"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&is_video=false&description=CVE-2021-43267 with CodeQL"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2021-43267 with CodeQL&body=Check out this article: http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&title=CVE-2021-43267 with CodeQL"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&title=CVE-2021-43267 with CodeQL"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&title=CVE-2021-43267 with CodeQL"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&title=CVE-2021-43267 with CodeQL"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&name=CVE-2021-43267 with CodeQL&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&t=CVE-2021-43267 with CodeQL"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-TIPC"><span class="toc-number">2.</span> <span class="toc-text">What is TIPC?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vulnerability-Analysis"><span class="toc-number">3.</span> <span class="toc-text">Vulnerability Analysis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-CodeQL"><span class="toc-number">4.</span> <span class="toc-text">Using CodeQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Create-Database"><span class="toc-number">4.1.</span> <span class="toc-text">Create Database</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Querying"><span class="toc-number">4.2.</span> <span class="toc-text">Querying</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Patch"><span class="toc-number">4.3.</span> <span class="toc-text">Patch</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CVE-2021-43267 with CodeQL
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Lothar</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-01-11T07:01:09.000Z" itemprop="datePublished">2023-01-11</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CVEs/">CVEs</a> › <a class="category-link" href="/categories/CVEs/CodeQL/">CodeQL</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><img src="/images/image-20230111150424481.png" alt="image-20230111150424481" style="zoom:50%;" />

<p>Basically, this CVE is a buffer overflow issue. From the previous description, we can tell that the issue is from a service called TIPC. So at the very beginning we should know what it is.</p>
<h2 id="What-is-TIPC"><a href="#What-is-TIPC" class="headerlink" title="What is TIPC?"></a>What is TIPC?</h2><p><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/networking/tipc.html">TIPC</a> (Transparent Inter Process Communication) is a protocol designed specifically for intra-cluster communication. It can be configured to transmit messages over UDP or directly over Ethernet. Message delivery is order-guaranteed, loss-free, and flow-controlled. Latency times are lower than any other known protocol, while maximum throughput is comparable to TCP.</p>
<p>For a more detailed and high-level description of the actual TIPC protocol, including the various ways messaging is performed and how Service Tracking works, it’s best to refer to <a target="_blank" rel="noopener" href="http://tipc.sourceforge.net/index.html">the official SourceForge page</a>.</p>
<h2 id="Vulnerability-Analysis"><a href="#Vulnerability-Analysis" class="headerlink" title="Vulnerability Analysis"></a>Vulnerability Analysis</h2><p>In September 2020, a new user message type was introduced called <code>MSG_CRYPTO</code>, which allows peers to send cryptographic keys.</p>
<p>The body of the messages is like:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tipc_aead_key</span> &#123;</span></span><br><span class="line">	<span class="type">char</span> alg_name[TIPC_AEAD_ALG_NAME];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> keylen; 	<span class="comment">/* in bytes */</span></span><br><span class="line">	<span class="type">char</span> key[];</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>

<p><code>TIPC_AEAD_ALG_NAME</code> is a macro for 32. And when the message is received,  the TIPC kernel module needs to copy this information into storage:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Allocate memory for the key */</span></span><br><span class="line">skey = kmalloc(size, GFP_ATOMIC);</span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Copy key from msg data */</span></span><br><span class="line">skey-&gt;keylen = ntohl(*((__be32 *)(data + TIPC_AEAD_ALG_NAME)));</span><br><span class="line"><span class="built_in">memcpy</span>(skey-&gt;alg_name, data, TIPC_AEAD_ALG_NAME);</span><br><span class="line"><span class="built_in">memcpy</span>(skey-&gt;key, data + TIPC_AEAD_ALG_NAME + <span class="keyword">sizeof</span>(__be32), skey-&gt;keylen);</span><br></pre></td></tr></table></figure>

<p>In <code>MSG_CRYPTO</code> messages, both the header size and the message size are validated against the actual packet size, so these values are guaranteed to be within the range of the actual packet, but for the size of the <code>keylen</code> member of the <code>MSG_CRYPTO</code> message or the key algorithm name itself (<code>TIPC_AEAD_ALG_NAME</code>) , and there is no similar check for message size. This means that an attacker can create a small packet to allocate heap memory and then write outside the boundaries of that location with an <strong>arbitrary</strong> size in the <code>keylen</code> property</p>
<h2 id="Using-CodeQL"><a href="#Using-CodeQL" class="headerlink" title="Using CodeQL"></a>Using CodeQL</h2><h3 id="Create-Database"><a href="#Create-Database" class="headerlink" title="Create Database"></a>Create Database</h3><p>First, we should download the Linux source code. The version here is <a target="_blank" rel="noopener" href="https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/linux-5.14.4.tar.gz">v5.14.4</a>. </p>
<p>After downloading and unzipping, we run <code>make menuconfig</code> in order to add the target module for the CVE. To enable the function we want here, should let <code>CONFIG_TIPC=y</code>. </p>
<p>Then we use the following command to create the database:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create ../linux-5.14.4-codeql-database --language=cpp --command=make</span><br></pre></td></tr></table></figure>

<h3 id="Querying"><a href="#Querying" class="headerlink" title="Querying"></a>Querying</h3><p>According to the previous analysis, we may look for the interesting <code>kmalloc</code> function.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import cpp</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> FunctionCall fc </span><br><span class="line"><span class="keyword">where</span> fc.getTarget().getName() <span class="operator">=</span> &quot;kmalloc&quot; </span><br><span class="line"><span class="keyword">and</span> fc.getArgument(<span class="number">0</span>).getType().getSize() <span class="operator">=</span> <span class="number">2</span> </span><br><span class="line"><span class="keyword">select</span> fc, fc.getLocation() </span><br></pre></td></tr></table></figure>

<p>Basically, the aim of the query is to get all the function calls where the target function is called <code>kmalloc</code> and the supplied size argument is a 16-bit int. Then output the call location and the string of the location.</p>
<h3 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h3><p>From GitHub we can find the patch and see what was changed.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">net/tipc/crypto.c | <span class="number">32</span> +++++++++++++++++++++-----------</span><br><span class="line"> <span class="number">1</span> file changed, <span class="number">21</span> <span class="built_in">insertions</span>(+), <span class="number">11</span> <span class="built_in">deletions</span>(-)</span><br><span class="line"></span><br><span class="line"> diff --git a/net/tipc/crypto.c b/net/tipc/crypto.c</span><br><span class="line"> index c9391d38d..dc60c32bb <span class="number">100644</span></span><br><span class="line"> --- a/net/tipc/crypto.c</span><br><span class="line"> +++ b/net/tipc/crypto.c</span><br><span class="line"> @@ <span class="number">-2285</span>,<span class="number">43</span> +<span class="number">2285</span>,<span class="number">53</span> @@ <span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">tipc_crypto_key_rcv</span><span class="params">(<span class="keyword">struct</span> tipc_crypto *rx, <span class="keyword">struct</span> tipc_msg *hdr)</span></span></span><br><span class="line"><span class="function">   u16 key_gen </span>= <span class="built_in">msg_key_gen</span>(hdr);</span><br><span class="line">   u16 size = <span class="built_in">msg_data_sz</span>(hdr);</span><br><span class="line">   u8 *data = <span class="built_in">msg_data</span>(hdr);</span><br><span class="line"></span><br><span class="line"> +   <span class="type">unsigned</span> <span class="type">int</span> keylen;</span><br><span class="line"> +</span><br><span class="line"> +   <span class="comment">/* Verify whether the size can exist in the packet */</span></span><br><span class="line"> +   <span class="keyword">if</span> (<span class="built_in">unlikely</span>(size &lt; <span class="built_in">sizeof</span>(<span class="keyword">struct</span> tipc_aead_key) + TIPC_AEAD_KEYLEN_MIN)) &#123;</span><br><span class="line"> +       <span class="built_in">pr_debug</span>(<span class="string">&quot;%s: message data size is too small\n&quot;</span>, rx-&gt;name);</span><br><span class="line"> +       <span class="keyword">goto</span> exit;</span><br><span class="line"> +   &#125;</span><br><span class="line"> +</span><br><span class="line"> +   keylen = <span class="built_in">ntohl</span>(*((__be32 *)(data + TIPC_AEAD_ALG_NAME)));</span><br><span class="line"> +</span><br><span class="line"> +   <span class="comment">/* Verify the supplied size values */</span></span><br><span class="line"> +   <span class="keyword">if</span> (<span class="built_in">unlikely</span>(size != keylen + <span class="built_in">sizeof</span>(<span class="keyword">struct</span> tipc_aead_key) ||</span><br><span class="line"> +            keylen &gt; TIPC_AEAD_KEY_SIZE_MAX)) &#123;</span><br><span class="line"> +       <span class="built_in">pr_debug</span>(<span class="string">&quot;%s: invalid MSG_CRYPTO key size\n&quot;</span>, rx-&gt;name);</span><br><span class="line"> +       <span class="keyword">goto</span> exit;</span><br><span class="line"> +   &#125;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">spin_lock</span>(&amp;rx-&gt;lock);</span><br><span class="line">     <span class="keyword">if</span> (<span class="built_in">unlikely</span>(rx-&gt;skey || (key_gen == rx-&gt;key_gen &amp;&amp; rx-&gt;key.keys))) &#123;</span><br><span class="line">	 <span class="built_in">pr_err</span>(<span class="string">&quot;%s: key existed &lt;%p&gt;, gen %d vs %d\n&quot;</span>, rx-&gt;name,</span><br><span class="line">		rx-&gt;skey, key_gen, rx-&gt;key_gen);</span><br><span class="line"> -        <span class="keyword">goto</span> exit;</span><br><span class="line"> +        <span class="keyword">goto</span> exit_unlock;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/* Allocate memory for the key */</span></span><br><span class="line">     skey = <span class="built_in">kmalloc</span>(size, GFP_ATOMIC);</span><br><span class="line">     <span class="keyword">if</span> (<span class="built_in">unlikely</span>(!skey)) &#123;</span><br><span class="line">	 <span class="built_in">pr_err</span>(<span class="string">&quot;%s: unable to allocate memory for skey\n&quot;</span>, rx-&gt;name);</span><br><span class="line"> -        <span class="keyword">goto</span> exit;</span><br><span class="line"> +        <span class="keyword">goto</span> exit_unlock;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Copy key from msg data */</span></span><br><span class="line"> -   skey-&gt;keylen = <span class="built_in">ntohl</span>(*((__be32 *)(data + TIPC_AEAD_ALG_NAME)));</span><br><span class="line"> +   skey-&gt;keylen = keylen;</span><br><span class="line">    <span class="built_in">memcpy</span>(skey-&gt;alg_name, data, TIPC_AEAD_ALG_NAME);</span><br><span class="line">    <span class="built_in">memcpy</span>(skey-&gt;key, data + TIPC_AEAD_ALG_NAME + <span class="built_in">sizeof</span>(__be32),</span><br><span class="line">			skey-&gt;keylen);</span><br><span class="line"></span><br><span class="line"> -   <span class="comment">/* Sanity check */</span></span><br><span class="line"> -   <span class="keyword">if</span> (<span class="built_in">unlikely</span>(size != <span class="built_in">tipc_aead_key_size</span>(skey))) &#123;</span><br><span class="line"> -       <span class="built_in">kfree</span>(skey);</span><br><span class="line"> -       skey = <span class="literal">NULL</span>;</span><br><span class="line"> -       <span class="keyword">goto</span> exit;</span><br><span class="line"> -   &#125;</span><br><span class="line"> -</span><br><span class="line">    rx-&gt;key_gen = key_gen;</span><br><span class="line">    rx-&gt;skey_mode = <span class="built_in">msg_key_mode</span>(hdr);</span><br><span class="line">    rx-&gt;skey = skey;</span><br><span class="line">    rx-&gt;nokey = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">mb</span>(); <span class="comment">/* for nokey flag */</span></span><br><span class="line"></span><br><span class="line"> - exit:</span><br><span class="line"> + exit_unlock:</span><br><span class="line">    <span class="built_in">spin_unlock</span>(&amp;rx-&gt;lock);</span><br><span class="line"> + exit:</span><br><span class="line">    <span class="comment">/* Schedule the key attaching on this crypto */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">likely</span>(skey &amp;&amp; <span class="built_in">queue_delayed_work</span>(tx-&gt;wq, &amp;rx-&gt;work, <span class="number">0</span>)))</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">--</span><br><span class="line"><span class="number">2.31</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<p>The data part of the TIPC message points to the <code>tipc_aead_key </code>structure. When the <code>tipc_crypto_key_rcv()</code> function allocates the <code>tipc_aead_key</code> space and copies the <code>tipc_aead_key-&gt;key</code>, it does not verify the validity of the <code>tipc_aead_key-&gt;keylen</code>, resulting in copying out of bounds. The validity check of <code>keylen</code> occurs after the out-of-bounds copy, and this check cannot prevent the memory that has been destroyed.</p>
<p>Only checking the header size and msg size of the TIPC message, but not checking <code>tipc_aead_key-&gt;keylen</code> of the <code>MSG_CRYPTO</code> message, is the cause of this vulnerability. At this time, the attacker can allocate heap memory by creating a TIPC message with a smaller <code>tipc_msg-&gt;size</code> , and then setting a <code>MSG_CRYPTO</code> message with a larger <code>tipc_aead_key-&gt;keylen</code> to trigger an out-of-bounds write.</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/categories/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/LotharShi">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-TIPC"><span class="toc-number">2.</span> <span class="toc-text">What is TIPC?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vulnerability-Analysis"><span class="toc-number">3.</span> <span class="toc-text">Vulnerability Analysis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-CodeQL"><span class="toc-number">4.</span> <span class="toc-text">Using CodeQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Create-Database"><span class="toc-number">4.1.</span> <span class="toc-text">Create Database</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Querying"><span class="toc-number">4.2.</span> <span class="toc-text">Querying</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Patch"><span class="toc-number">4.3.</span> <span class="toc-text">Patch</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&text=CVE-2021-43267 with CodeQL"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&title=CVE-2021-43267 with CodeQL"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&is_video=false&description=CVE-2021-43267 with CodeQL"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2021-43267 with CodeQL&body=Check out this article: http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&title=CVE-2021-43267 with CodeQL"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&title=CVE-2021-43267 with CodeQL"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&title=CVE-2021-43267 with CodeQL"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&title=CVE-2021-43267 with CodeQL"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&name=CVE-2021-43267 with CodeQL&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://lotharshi.github.io/2023/01/11/CVE-2021-43267-with-CodeQL/&t=CVE-2021-43267 with CodeQL"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022-2023
    Lothar
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/categories/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/LotharShi">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RJJPDKLTJM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-RJJPDKLTJM');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
