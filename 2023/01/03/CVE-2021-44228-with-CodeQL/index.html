<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Introduction  Log4j is a library which is often used for logging in java development. However, in November 2021, it was revealed that log4j has a RCE vulnerability, causing nearly 70% of companies to">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-44228 with CodeQL">
<meta property="og:url" content="http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/index.html">
<meta property="og:site_name" content="Where Lothar Writes Blogs">
<meta property="og:description" content="Introduction  Log4j is a library which is often used for logging in java development. However, in November 2021, it was revealed that log4j has a RCE vulnerability, causing nearly 70% of companies to">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://lotharshi.github.io/images/image-202301038942018829.png">
<meta property="og:image" content="http://lotharshi.github.io/images/image-20230103160830850.png">
<meta property="og:image" content="http://lotharshi.github.io/images/image-20230103163127378.png">
<meta property="article:published_time" content="2023-01-03T07:38:11.000Z">
<meta property="article:modified_time" content="2023-01-03T09:06:50.880Z">
<meta property="article:author" content="Lothar">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://lotharshi.github.io/images/image-202301038942018829.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>CVE-2021-44228 with CodeQL</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/categories/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/LotharShi">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/11/05/CVE-2022-39197-with-CodeQL/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&text=CVE-2021-44228 with CodeQL"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&title=CVE-2021-44228 with CodeQL"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&is_video=false&description=CVE-2021-44228 with CodeQL"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2021-44228 with CodeQL&body=Check out this article: http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&title=CVE-2021-44228 with CodeQL"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&title=CVE-2021-44228 with CodeQL"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&title=CVE-2021-44228 with CodeQL"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&title=CVE-2021-44228 with CodeQL"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&name=CVE-2021-44228 with CodeQL&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&t=CVE-2021-44228 with CodeQL"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vulnerabilities"><span class="toc-number">2.</span> <span class="toc-text">Vulnerabilities</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-CodeQL"><span class="toc-number">3.</span> <span class="toc-text">Using CodeQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Create-Database"><span class="toc-number">3.1.</span> <span class="toc-text">Create Database</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Querying"><span class="toc-number">3.2.</span> <span class="toc-text">Querying</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Writing-Queries"><span class="toc-number">3.2.1.</span> <span class="toc-text">Writing Queries</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Verifing-Results"><span class="toc-number">3.2.2.</span> <span class="toc-text">Verifing Results</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">4.</span> <span class="toc-text">Reference</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CVE-2021-44228 with CodeQL
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Lothar</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-01-03T07:38:11.000Z" itemprop="datePublished">2023-01-03</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CVEs/">CVEs</a> › <a class="category-link" href="/categories/CVEs/CodeQL/">CodeQL</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><img src="/images/image-202301038942018829.png" alt="" style="zoom: 50%;" />

<p>Log4j is a library which is often used for logging in java development. However, in November 2021, it was revealed that log4j has a RCE vulnerability, causing nearly <strong>70%</strong> of companies to be affected by this incident. The vulnerability is due to the <strong>recursive parsing function</strong> in some functions of Apache Log4j2. Attackers can directly construct malicious requests to trigger remote code execution vulnerabilities.</p>
<p>Impacted Version: Apache Log4j 2.x &lt;&#x3D; 2.14.1</p>
<h2 id="Vulnerabilities"><a href="#Vulnerabilities" class="headerlink" title="Vulnerabilities"></a>Vulnerabilities</h2><p><a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228">CVE-2022-44228</a></p>
<p>There are too many analysis about the vulnerablity itself on the Internet. So there will be no repeat here. </p>
<h2 id="Using-CodeQL"><a href="#Using-CodeQL" class="headerlink" title="Using CodeQL"></a>Using CodeQL</h2><h3 id="Create-Database"><a href="#Create-Database" class="headerlink" title="Create Database"></a>Create Database</h3><p>To use CodeQL, the first time should always be creating a database. Since Log4j is a open-source utility, we can download the source code from the official website and I found the release from Github. Because of the version specification, I select the version of <code>2.14.1</code> from the past releases, which corresponding commit is <a target="_blank" rel="noopener" href="https://github.com/apache/logging-log4j2/commit/be881e503e14b267fb8a8f94b6d15eddba7ed8c4"><code>be881e5</code></a>.</p>
<p>Since we already know that our target is the contents from <code>log4j-core</code> and <code>log4j-api</code>, so we should modify the <code>pom.xml</code> inside the source code to indicate the part we want to compile instead of compile them all. </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">module</span>&gt;</span>log4j-api-java9<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">module</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">module</span>&gt;</span>log4j-core-java9<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">module</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- the rest of the modules should be commented. --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>After this, we run the following command to build the database.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create Log4jDB --language=java --overwrite --command=&quot;mvn clean install -Dmaven.test.skip=true&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Querying"><a href="#Querying" class="headerlink" title="Querying"></a>Querying</h3><h4 id="Writing-Queries"><a href="#Writing-Queries" class="headerlink" title="Writing Queries"></a>Writing Queries</h4><p>FIrst of all, according to the previous analysis, we know that the essence of this CVE is JNDI. So in order to find the vulnerability of JNDI, we need to find a call of  <code>InitialContext#lookup</code> method. The project <a target="_blank" rel="noopener" href="https://github.dev/SummerSec/LookupInterface">LookupInterface</a> has already integrated the common classes which request JNDI, so we make some adjustment on it like this: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Context</span> <span class="keyword">extends</span>  <span class="title class_">RefType</span>&#123;</span><br><span class="line">    Context()&#123;</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;javax.naming&quot;</span>, <span class="string">&quot;Context&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;javax.naming&quot;</span>, <span class="string">&quot;InitialContext&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiCallback&quot;</span>)</span><br><span class="line">        or </span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiTemplate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiLocatorDelegate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.apache.shiro.jndi&quot;</span>, <span class="string">&quot;JndiCallback&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiCallback&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiLocatorDelegate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiTemplate&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from Call call,Callable parseExpression</span><br><span class="line">where</span><br><span class="line">    call.getCallee() = parseExpression and </span><br><span class="line">    parseExpression.getDeclaringType() <span class="keyword">instanceof</span> Context and</span><br><span class="line">    parseExpression.hasName(<span class="string">&quot;lookup&quot;</span>)</span><br><span class="line">select call</span><br></pre></td></tr></table></figure>

<p>The result is at the right side as following. </p>
<img src="/images/image-20230103160830850.png" alt="image-20230103160830850" style="zoom:50%;" />

<p>Hereby, we have found two sinks. We also need to find the source then. As we (might) already know, Log4j will use several methods like <code>error/fatal/info/debug/trace/</code> to record different levels of logs. And through some analysis we get to know that our inputs all called the method named <code>logIfEnable</code> and were input as the fourth parameter. Thus, the source could be defined. </p>
<p>Besides, CodeQL library provides an <code>TaintTracking::Configuration</code> class, which sets the starting point and ending point by overriding the <code>isSource</code> method and <code>isSink</code> method. And similarly, we also modify the source part of  <a target="_blank" rel="noopener" href="https://github.dev/SummerSec/LookupInterface">LookupInterface</a> code to do the taint tracing. </p>
<p>We take <code>error</code> as an example and the code is as following.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@name</span> Tainttrack Context lookup</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@kind</span> path-problem</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> java</span><br><span class="line"><span class="keyword">import</span> semmle.code.java.dataflow.FlowSources</span><br><span class="line"><span class="keyword">import</span> DataFlow::PathGraph</span><br><span class="line"><span class="comment">// Constrain the type of lookup </span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Context</span> <span class="keyword">extends</span>  <span class="title class_">RefType</span>&#123;</span><br><span class="line">    Context()&#123;</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;javax.naming&quot;</span>, <span class="string">&quot;Context&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;javax.naming&quot;</span>, <span class="string">&quot;InitialContext&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiCallback&quot;</span>)</span><br><span class="line">        or </span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiTemplate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiLocatorDelegate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.apache.shiro.jndi&quot;</span>, <span class="string">&quot;JndiCallback&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiCallback&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiLocatorDelegate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiTemplate&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Constrain the type of error</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Logger</span> <span class="keyword">extends</span>  <span class="title class_">RefType</span>&#123;</span><br><span class="line">    Logger()&#123;</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.apache.logging.log4j.spi&quot;</span>, <span class="string">&quot;AbstractLogger&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Constrain Expr as sink</span></span><br><span class="line">predicate <span class="title function_">isLookup</span><span class="params">(Expr arg)</span> &#123;</span><br><span class="line">    exists(MethodAccess ma |</span><br><span class="line">        ma.getMethod().getName() = <span class="string">&quot;lookup&quot;</span></span><br><span class="line">        and</span><br><span class="line">        ma.getMethod().getDeclaringType() <span class="keyword">instanceof</span> Context</span><br><span class="line">        <span class="type">and</span></span><br><span class="line">        <span class="variable">arg</span> <span class="operator">=</span> ma.getArgument(<span class="number">0</span>)</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Constrain Method to get the error method of AbstractLogger </span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoggerInput</span> <span class="keyword">extends</span>  <span class="title class_">Method</span> &#123;</span><br><span class="line">    LoggerInput()&#123;</span><br><span class="line">        <span class="built_in">this</span>.getDeclaringType() <span class="keyword">instanceof</span> Logger and</span><br><span class="line">        <span class="built_in">this</span>.hasName(<span class="string">&quot;error&quot;</span>) and <span class="built_in">this</span>.getNumberOfParameters() = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// To get the first parameter of the previous method</span></span><br><span class="line">    Parameter <span class="title function_">getAnUntrustedParameter</span><span class="params">()</span> &#123; result = <span class="built_in">this</span>.getParameter(<span class="number">0</span>) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Taint Trcae</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TainttrackLookup</span>  <span class="keyword">extends</span> <span class="title class_">TaintTracking</span>::Configuration &#123;</span><br><span class="line">    TainttrackLookup() &#123; </span><br><span class="line">        <span class="built_in">this</span> = <span class="string">&quot;TainttrackLookup&quot;</span> </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override predicate <span class="title function_">isSource</span><span class="params">(DataFlow::Node source)</span> &#123;</span><br><span class="line">        exists(LoggerInput LoggerMethod | source.asParameter() = LoggerMethod.getAnUntrustedParameter())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override predicate <span class="title function_">isSink</span><span class="params">(DataFlow::Node sink)</span> &#123;</span><br><span class="line">        exists(Expr arg |</span><br><span class="line">            isLookup(arg)</span><br><span class="line">            and</span><br><span class="line">            sink.asExpr() = arg</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">// Lookup Statements</span></span><br><span class="line">from TainttrackLookup config , DataFlow::PathNode source, DataFlow::PathNode sink</span><br><span class="line">where</span><br><span class="line">    config.hasFlowPath(source, sink)</span><br><span class="line">select sink.getNode(), source, sink, <span class="string">&quot;unsafe lookup&quot;</span>, source.getNode(), <span class="string">&quot;this is user input&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="Verifing-Results"><a href="#Verifing-Results" class="headerlink" title="Verifing Results"></a>Verifing Results</h4><p>After we run the previous query, we get four chains.</p>
<img src="/images/image-20230103163127378.png" alt="image-20230103163127378" style="zoom:50%;" />

<p>Though the chains ends at <code>name    JndiManager.java:172:40</code>, none of them is the authentic chain. There are still some issues like inside <code>AbstractLogger#tryLogMessage</code>, CodeQL will go to <code>AbstractLogger#log</code> but the actual requests will go to <code>Logger#log</code>. This is because <code>Logger</code> is a child class of <code>AbstractLogger</code> and also achieve the <code>log</code> method. Since Logger object is what we instantiate, we call <code>Logger#log</code> here.</p>
<p>There are several analysis on the Internet about this CVE with CodeQL. But somehow sadly I couldn’t reproduce the process they showed. </p>
<p>Here’s the final code:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@name</span> Tainttrack Context lookup</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@kind</span> path-problem</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> java</span><br><span class="line"><span class="keyword">import</span> semmle.code.java.dataflow.FlowSources</span><br><span class="line"><span class="keyword">import</span> DataFlow::PathGraph</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Context</span> <span class="keyword">extends</span>  <span class="title class_">RefType</span>&#123;</span><br><span class="line">    Context()&#123;</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;javax.naming&quot;</span>, <span class="string">&quot;Context&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;javax.naming&quot;</span>, <span class="string">&quot;InitialContext&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiCallback&quot;</span>)</span><br><span class="line">        or </span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiTemplate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiLocatorDelegate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.apache.shiro.jndi&quot;</span>, <span class="string">&quot;JndiCallback&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiCallback&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiLocatorDelegate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiTemplate&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Logger</span> <span class="keyword">extends</span>  <span class="title class_">RefType</span>&#123;</span><br><span class="line">    Logger()&#123;</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.apache.logging.log4j.spi&quot;</span>, <span class="string">&quot;AbstractLogger&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoggerInput</span> <span class="keyword">extends</span>  <span class="title class_">Method</span> &#123;</span><br><span class="line">    LoggerInput()&#123;</span><br><span class="line">        <span class="built_in">this</span>.getDeclaringType() <span class="keyword">instanceof</span> Logger and</span><br><span class="line">        <span class="built_in">this</span>.hasName(<span class="string">&quot;error&quot;</span>) and <span class="built_in">this</span>.getNumberOfParameters() = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    Parameter <span class="title function_">getAnUntrustedParameter</span><span class="params">()</span> &#123; result = <span class="built_in">this</span>.getParameter(<span class="number">0</span>) &#125;</span><br><span class="line">&#125;</span><br><span class="line">predicate <span class="title function_">isLookup</span><span class="params">(Expr arg)</span> &#123;</span><br><span class="line">    exists(MethodAccess ma |</span><br><span class="line">        ma.getMethod().getName() = <span class="string">&quot;lookup&quot;</span></span><br><span class="line">        and</span><br><span class="line">        ma.getMethod().getDeclaringType().getASupertype*().getSourceDeclaration() <span class="keyword">instanceof</span> Context</span><br><span class="line">        <span class="type">and</span></span><br><span class="line">        <span class="variable">arg</span> <span class="operator">=</span> ma.getArgument(<span class="number">0</span>)</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TainttrackLookup</span>  <span class="keyword">extends</span> <span class="title class_">TaintTracking</span>::Configuration &#123;</span><br><span class="line">    TainttrackLookup() &#123; </span><br><span class="line">        <span class="built_in">this</span> = <span class="string">&quot;TainttrackLookup&quot;</span> </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override predicate <span class="title function_">isSource</span><span class="params">(DataFlow::Node source)</span> &#123;</span><br><span class="line">        exists(LoggerInput LoggerMethod |</span><br><span class="line">            source.asParameter() = LoggerMethod.getAnUntrustedParameter())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override predicate <span class="title function_">isAdditionalTaintStep</span><span class="params">(DataFlow::Node fromNode, DataFlow::Node toNode)</span> &#123;</span><br><span class="line">        exists(MethodAccess ma,MethodAccess ma2 |</span><br><span class="line">            ma.getMethod().getDeclaringType().hasQualifiedName(<span class="string">&quot;org.apache.logging.log4j.core.impl&quot;</span>, <span class="string">&quot;ReusableLogEventFactory&quot;</span>) </span><br><span class="line">            and ma.getMethod().hasName(<span class="string">&quot;createEvent&quot;</span>) and fromNode.asExpr()=ma.getArgument(<span class="number">5</span>) and ma2.getMethod().getDeclaringType().hasQualifiedName(<span class="string">&quot;org.apache.logging.log4j.core.config&quot;</span>, <span class="string">&quot;LoggerConfig&quot;</span>)  </span><br><span class="line">            and ma2.getMethod().hasName(<span class="string">&quot;log&quot;</span>) and ma2.getMethod().getNumberOfParameters() = <span class="number">2</span> and toNode.asExpr()=ma2.getArgument(<span class="number">0</span>)</span><br><span class="line">                    )</span><br><span class="line">      &#125;</span><br><span class="line">    override predicate <span class="title function_">isSink</span><span class="params">(DataFlow::Node sink)</span> &#123;</span><br><span class="line">        exists(Expr arg |</span><br><span class="line">            isLookup(arg)</span><br><span class="line">            and</span><br><span class="line">            sink.asExpr() = arg</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line">from TainttrackLookup config , DataFlow::PathNode source, DataFlow::PathNode sink</span><br><span class="line">where</span><br><span class="line">    config.hasFlowPath(source, sink)</span><br><span class="line">select sink.getNode(), source, sink, <span class="string">&quot;unsafe lookup&quot;</span>, source.getNode(), <span class="string">&quot;this is user input&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10707">Analysis 1</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/318141.html">Analysis 2</a></p>
<p><a target="_blank" rel="noopener" href="https://tttang.com/archive/1570/">Analysis 3</a></p>
<p><a target="_blank" rel="noopener" href="https://tttang.com/archive/1660/">JNDI with CodeQL</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/categories/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/LotharShi">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vulnerabilities"><span class="toc-number">2.</span> <span class="toc-text">Vulnerabilities</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-CodeQL"><span class="toc-number">3.</span> <span class="toc-text">Using CodeQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Create-Database"><span class="toc-number">3.1.</span> <span class="toc-text">Create Database</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Querying"><span class="toc-number">3.2.</span> <span class="toc-text">Querying</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Writing-Queries"><span class="toc-number">3.2.1.</span> <span class="toc-text">Writing Queries</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Verifing-Results"><span class="toc-number">3.2.2.</span> <span class="toc-text">Verifing Results</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">4.</span> <span class="toc-text">Reference</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&text=CVE-2021-44228 with CodeQL"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&title=CVE-2021-44228 with CodeQL"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&is_video=false&description=CVE-2021-44228 with CodeQL"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2021-44228 with CodeQL&body=Check out this article: http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&title=CVE-2021-44228 with CodeQL"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&title=CVE-2021-44228 with CodeQL"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&title=CVE-2021-44228 with CodeQL"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&title=CVE-2021-44228 with CodeQL"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&name=CVE-2021-44228 with CodeQL&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://lotharshi.github.io/2023/01/03/CVE-2021-44228-with-CodeQL/&t=CVE-2021-44228 with CodeQL"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022-2023
    Lothar
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/categories/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/LotharShi">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RJJPDKLTJM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-RJJPDKLTJM');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
